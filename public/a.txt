<div class="md-contents article-content__body my-2 flex-fill">
<p>Ng&agrave;y xÆ°a l&agrave;m project training vá» website order thá»©c Äƒn m&igrave;nh l&agrave;m chá»©c nÄƒng Ä‘áº¿m sá»‘ lÆ°á»£t xem sáº£n pháº©m nhÆ° sau: Th&ecirc;m má»™t column l&agrave; count_views v&agrave;o báº£ng products rá»“i xá»¯ l&yacute; (trong controller) tÄƒng count_views l&ecirc;n 1 v&agrave; update v&agrave;o database má»—i láº§n ngÆ°á»i d&ugrave;ng click v&agrave;o trang chi tiáº¿t sáº£n pháº©m. Ä&uacute;ng l&agrave; khi xÆ°a ta b&eacute; ta ngu, c&aacute;ch l&agrave;m n&agrave;y ráº¥t kh&ocirc;ng Ä‘&uacute;ng v&agrave; risk cá»§a n&oacute; th&igrave; cháº¯c c&aacute;c báº¡n Ä‘&atilde; biáº¿t rá»“i, m&igrave;nh kh&ocirc;ng n&oacute;i th&ecirc;m ná»¯a. H&ocirc;m nay m&igrave;nh viáº¿t b&agrave;i n&agrave;y Ä‘á»ƒ chia sáº½ c&aacute;c báº¡n c&aacute;ch l&agrave;m chá»©c nÄƒng Ä‘áº¿m sá»‘ lÆ°á»£t xem trang má»™t c&aacute;ch Ä‘&uacute;ng Ä‘áº¯n hÆ¡n, sá»­ dá»¥ng Events v&agrave; Middleware trong Laravel. Náº¿u báº¡n n&agrave;o muá»‘n d&ugrave;ng package Ä‘á»ƒ l&agrave;m chá»©c nÄƒng n&agrave;y th&igrave; c&oacute; thá»ƒ sá»­ dá»¥ng package <a href="https://github.com/Kryptonit3/Counter" target="_blank">n&agrave;y</a>. Náº¿u báº¡n quyáº¿t Ä‘á»‹nh d&ugrave;ng package th&igrave; báº¡n c&oacute; thá»ƒ dá»«ng Ä‘á»c b&agrave;i n&agrave;y á»Ÿ Ä‘&acirc;y Ä‘Æ°á»£c rá»“i <img alt="ğŸ˜ƒ" class="emoji" draggable="false" src="https://twemoji.maxcdn.com/2/72x72/1f603.png" /></p>

<p>OK, ch&uacute;ng ta c&ugrave;ng nhau báº¯t Ä‘áº§u nh&eacute; Äáº§u ti&ecirc;n ch&uacute;ng ta sáº½ táº¡o table posts sá»­ dá»¥ng lá»‡nh quen thuá»™c sau:</p>

<p><code>php artisan make:migration create_posts_table --create=&quot;posts&quot;</code></p>

<p>Tiáº¿p Ä‘áº¿n l&agrave; th&ecirc;m má»™t sá»‘ fields v&agrave;o table posts nhÆ° sau:</p>

<pre class="prettyprint" data-filename="">
<code class="prettyprint">public function up()
{
    Schema::create(&#39;posts&#39;, function (Blueprint $table)
    {
        $table-&gt;increments(&#39;id&#39;);
        $table-&gt;string(&#39;title&#39;);
        $table-&gt;text(&#39;content&#39;);
        $table-&gt;integer(&#39;view_count&#39;)-&gt;default(0);
        $table-&gt;timestamps();
    });
}
</code></pre>

<p>Tiáº¿p theo, cháº¡y lá»‡nh sau Ä‘á»ƒ n&oacute; sinh table posts trong Database nh&eacute;</p>

<p><code>php artisan migrate</code></p>

<p>Ch&uacute;ng ta sáº½ táº¡o tiáº¿p Model Post, Controller PostsController v&agrave; Route.</p>

<pre class="prettyprint" data-filename="">
<code class="prettyprint">namespace App\Demo;

use Illuminate\Database\Eloquent\Model;

class Post extends Model
{
    protected $fillable = [ &#39;title&#39;, &#39;content&#39; ];
}
</code></pre>

<p><code>php artisan make:controller PostsController</code></p>

<p><code>Route::resource(&#39;posts&#39;, &#39;PostsController&#39;);</code></p>

<p>Äá»ƒ tÄƒng sá»‘ lÆ°á»£t xem cá»§a post m&igrave;nh cáº§n sá»­ dá»¥ng Event trong Laravel, n&oacute; cho ph&eacute;p ch&uacute;ng ta k&iacute;ch hoáº¡t c&aacute;c h&agrave;nh Ä‘á»™ng á»©ng vá»›i c&aacute;c sá»± kiá»‡n tÆ°Æ¡ng á»©ng. C&oacute; thá»ƒ báº¡n Ä‘&atilde; sá»­ dá»¥ng n&oacute; khi l&agrave;m viá»‡c vá»›i Eloquent rá»“i pháº£i kh&ocirc;ng n&agrave;o, n&oacute; Ä‘áº·t biá»‡t há»¯u dá»¥ng trong trÆ°á»ng há»£p báº¡n muá»‘n validate Model khi c&aacute;c h&agrave;nh Ä‘á»™ng created,updated&hellip; Ä‘Æ°á»£c thá»±c hiá»‡n. C&aacute;c báº¡n c&oacute; thá»ƒ tham kháº£o th&ecirc;m táº¡i <a href="https://laravel.com/docs/5.4/eloquent#events" target="_blank">link</a> n&agrave;y nh&eacute;. Váº­y th&igrave; l&agrave;m c&aacute;ch n&agrave;o Ä‘á»ƒ ch&uacute;ng ta c&oacute; thá»ƒ apply n&oacute; v&agrave;o chá»©c nÄƒng Ä‘áº¿m sá»‘ lÆ°á»£t xem b&agrave;i post cá»§a ch&uacute;ng ta. Äáº§u ti&ecirc;n ch&uacute;ng ta sáº½ táº¡o má»™t Event m&agrave; n&oacute; sáº½ Ä‘Æ°á»£c k&iacute;ch hoáº¡t má»—i khi ngÆ°á»i d&ugrave;ng view b&agrave;i post. Muá»‘n t&iacute;nh lÆ°á»£t xem cho page n&agrave;o th&igrave; ta chá»‰ cáº§n hook Event n&agrave;y v&agrave;o l&agrave; xong.Vá»›i c&aacute;ch l&agrave;m n&agrave;y ch&uacute;ng ta Ä‘ang break xá»¯ l&yacute; logic ra khá»i controller v&agrave; viáº¿t n&oacute; trong má»™t class chuy&ecirc;n biá»‡t hÆ¡n, viá»‡c n&agrave;y l&agrave;m cho code trá»Ÿ n&ecirc;n clear v&agrave; dá»… maintain hÆ¡n nhiá»u pháº£i kh&ocirc;ng n&agrave;o. B&acirc;y giá» th&igrave; controller sáº½ Ä‘Æ¡n giáº£n v&agrave; ngáº¯n gá»n nhÆ° sau:</p>

<pre class="prettyprint" data-filename="">
<code class="prettyprint">use App\Demo\Post;

public function show($id)
{
    $post = Post::find($id);
    Event::fire(&#39;posts.view&#39;, $post);

    return View::make(&#39;posts.show&#39;)-&gt;withPost($post);
}
</code></pre>

<p>Laravel cho ph&eacute;p ch&uacute;ng ta Ä‘Äƒng k&yacute; má»™t lá»›p Ä‘&oacute;ng vai tr&ograve; láº¯ng nghe sá»± kiá»‡n v&agrave; máº·c Ä‘á»‹nh n&oacute; sáº½ gá»i phÆ°Æ¡ng thá»©c handle cá»§a lá»›p n&agrave;y Ä‘á»ƒ xá»¯ l&yacute; má»—i khi sá»± kiá»‡n Ä‘Æ°á»£c k&iacute;ch hoáº¡t.</p>

<pre class="prettyprint" data-filename="">
<code class="prettyprint">namespace App\Demo\Events;

use App\Demo\Post;

class ViewPostHandler
{
    public function handle(Post $post)
    {
        $post-&gt;increment(&#39;view_count&#39;);
    }
}
</code></pre>

<p>Tiáº¿p theo l&agrave; bÆ°á»›c Ä‘Äƒng k&yacute;. Báº¡n c&oacute; thá»ƒ Ä‘Äƒng k&yacute; trong phÆ°Æ¡ng thá»©c boot cá»§a EventServiceProvider. <code>Event::listen(&#39;posts.view&#39;, &#39;App\Demo\Events\ViewPostHandler&#39;);</code></p>

<p>B&acirc;y giá» má»—i l&uacute;c b&agrave;i post Ä‘Æ°á»£c hiá»ƒn thá»‹ th&igrave; sá»± kiá»‡n &quot;post.view&quot; Ä‘Æ°á»£c k&iacute;ch hoáº¡t v&agrave; n&oacute; sáº½ tÄƒng sá»‘ lÆ°á»£t view trang l&ecirc;n 1.NhÆ°ng Ä‘iá»u g&igrave; sáº½ x&atilde;y ra náº¿u ngÆ°á»i d&ugrave;ng v&agrave;o xem má»™t b&agrave;i post v&agrave; nháº¥n F5 li&ecirc;n tá»¥c. Sá»‘ lÆ°á»£t view sáº½ tÄƒng li&ecirc;n tá»¥c, kh&ocirc;ng á»•n, ch&uacute;ng ta sáº½ sá»­ dá»¥ng Session v&agrave; Middleware Ä‘á»ƒ giáº£i quyáº¿t váº¥n Ä‘á» n&agrave;y. C&aacute;c báº¡n sá»­a láº¡i class ViewPostHandler nhÆ° sau nh&eacute;</p>

<pre class="prettyprint" data-filename="">
<code class="prettyprint">namespace App\Demo\Events;

use App\Demo\Post;
use Illuminate\Session\Store;

class ViewPostHandler
{
    private $session;

    public function __construct(Store $session)
    {
        $this-&gt;session = $session;
    }

    public function handle(Post $post)
	{
	    if (!$this-&gt;isPostViewed($post))
	    {
	        $post-&gt;increment(&#39;view_count&#39;);
	        $this-&gt;storePost($post);
	    }
	}

	private function isPostViewed($post)
	{
	    $viewed = $this-&gt;session-&gt;get(&#39;viewed_posts&#39;, []);

	    return array_key_exists($post-&gt;id, $viewed);
	}

	private function storePost($post)
	{
	    $key = &#39;viewed_posts.&#39; . $post-&gt;id;

	    $this-&gt;session-&gt;put($key, time());
	}
}
</code></pre>

<p>Tiáº¿p theo ch&uacute;ng ta sáº½ x&acirc;y dá»±ng middleware Filter, vá»›i middleware n&agrave;y th&igrave; ch&uacute;ng ta chá»‰ cho ph&eacute;p tÄƒng biáº¿n Ä‘áº¿m view_count sau má»™t khoáº£ng thá»i gian nháº¥t Ä‘á»‹nh (á»Ÿ Ä‘&acirc;y m&igrave;nh Ä‘á»ƒ 1 giá»)</p>

<pre class="prettyprint" data-filename="">
<code class="prettyprint">namespace App\Http\Middleware;

use Closure;
use Illuminate\Session\Store;
use Session;

class Filter
{
    private $session;

    public function __construct(Store $session)
    {
        $this-&gt;session = $session;
    }

    /**
     * Handle an incoming request.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  \Closure  $next
     * @return mixed
     */
    public function handle($request, Closure $next)
    {
        $posts = $this-&gt;getViewedPosts();

        if (!is_null($posts))
        {
            $posts = $this-&gt;cleanExpiredViews($posts);
            $this-&gt;storePosts($posts);
        }

        return $next($request);
    }

    private function getViewedPosts()
    {
        return $this-&gt;session-&gt;get(&#39;viewed_posts&#39;, null);
    }

    private function cleanExpiredViews($posts)
    {
        $time = time();

        // Let the views expire after one hour.
        $throttleTime = 3600;

        return array_filter($posts, function ($timestamp) use ($time, $throttleTime)
        {
            return ($timestamp + $throttleTime) &gt; $time;
        });
    }

    private function storePosts($posts)
    {
        $this-&gt;session-&gt;put(&#39;viewed_posts&#39;, $posts);
    }
}
</code></pre>

<p>BÆ°á»›c cuá»‘i c&ugrave;ng l&agrave; Ä‘Äƒng k&yacute; middleware n&agrave;y trong Kernel v&agrave; th&ecirc;m middleware v&agrave;o cho route <code>&#39;filter&#39; =&gt; \App\Http\Middleware\Filter::class,</code></p>

<pre class="prettyprint" data-filename="">
<code class="prettyprint">Route::group([&#39;middleware&#39; =&gt; &#39;filter&#39;], function() {
    Route::resource(&#39;posts&#39;, &#39;PostsController&#39;);
});
</code></pre>

<p>NhÆ° váº­y l&agrave; m&igrave;nh Ä‘&atilde; ho&agrave;n th&agrave;nh xong chá»©c nÄƒng Ä‘áº¿m sá»‘ lÆ°á»£t xem trang rá»“i, kh&aacute; Ä‘Æ¡n giáº£n pháº£i kh&ocirc;ng n&agrave;o, cáº£m Æ¡n c&aacute;c báº¡n Ä‘&atilde; Ä‘á»c.</p>
</div>
